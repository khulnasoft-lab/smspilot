(function(window,document,$,undefined){var XHR_STATE_NOT_INIT=0;var XHR_STATE_SETUP=1;var XHR_STATE_SENT=2;var XHR_STATE_PROCESSING=3;var XHR_STATE_COMPLETE=4;function _ucfirst(str){str+='';return str.charAt(0).toUpperCase()+str.substr(1)}
function _fnKeyStructData(key,data){var result={};if(data.length===0)return{};if(!$.isArray(data))
throw new Error('Unable to parse data set, not in array format');if(!$.isPlainObject(data[0]))
throw new Error('Unable to parse data set, structure needs to be an array of objects');if(typeof data[0][key]==='undefined')
throw new Error('Unable to parse data set, key "'+key+'" not found');$.each(data,function(k,v){if(typeof v[key]==='undefined')
throw new Error('Unable to parse data set, key "'+key+'" not found at instance # '+k);result[v[key]]=v});return result}
function _fnGetChanges(dataA,dataB){var updates={create:[],delete:[],update:{}};$.each(dataA,function(k,v){if(typeof dataB[k]==='undefined')
updates.delete.push(k.toString());else if(JSON.stringify(v)!==JSON.stringify(dataB[k]))
updates.update[k]=dataB[k];delete(dataB[k])});$.each(dataB,function(k,v){updates.create.push(v)});return updates.create.length||updates.delete.length||Object.keys(updates.update).length?updates:null}
function _fnCallbackFire(dtSettings,callbackArr,eventName,args,namespace){var ret=[];if(callbackArr){ret=$.map(dtSettings[callbackArr].slice().reverse(),function(val,i){return val.fn.apply(dtSettings.oInstance,args)})}
if(eventName!==null){var e=$.Event(eventName+'.'+(namespace||'dt'));$(dtSettings.nTable).trigger(e,args);ret.push(e.result)}
return ret}
function _fnLog(dtSettings,level,msg,tn){msg='[LiveAjax] DataTables warning: '+(dtSettings?'table id='+dtSettings.sTableId+' - ':'')+msg;if(tn){msg+='. For more information about this error, please see '+'http://datatables.net/tn/'+tn}
if(!level){var ext=$.fn.dataTableExt;var type=ext.sErrMode||ext.errMode;if(dtSettings){_fnCallbackFire(dtSettings,null,'error',[dtSettings,tn,msg])}
if(type=='alert'){alert(msg)}else if(type=='throw'){throw new Error(msg)}else if(typeof type=='function'){type(dtSettings,tn,msg)}}else if(window.console&&console.log){console.log(msg)}}
function _fnDtCallbackEnabled(dtSettings,callback){return(dtSettings.liveAjax.dtCallbacks===!0||($.isArray(dtSettings.liveAjax.dtCallbacks)&&$.inArray(callback,dtSettings.liveAjax.dtCallbacks)!==-1))}
function _fnProcessingDisplay(dtSettings,show){if(dtSettings.oFeatures.bProcessing){$(dtSettings.aanFeatures.r).css('display',show?'block':'none')}
_fnCallbackFire(dtSettings,null,'processing',[dtSettings,show])}
function _fnBuildAjax(dtSettings,data,fn){if(_fnDtCallbackEnabled(dtSettings,'serverParams'))
_fnCallbackFire(dtSettings,'aoServerParams','serverParams',[data]);if(data&&$.isArray(data)){var tmp={};var rbracket=/(.*?)\[\]$/;$.each(data,function(key,val){var match=val.name.match(rbracket);if(match){var name=match[0];if(!tmp[name]){tmp[name]=[]}
tmp[name].push(val.value)}else{tmp[val.name]=val.value}});data=tmp}
var xhrStart;var ajaxData;var ajax=dtSettings.ajax;var instance=dtSettings.oInstance;var callback=function(json){if(_fnDtCallbackEnabled(dtSettings,'xhr'))
_fnCallbackFire(dtSettings,null,'xhr',[dtSettings,json,dtSettings.jqXHR]);fn(json)};if($.isPlainObject(ajax)&&ajax.data){ajaxData=ajax.data;var newData=$.isFunction(ajaxData)?ajaxData(data,dtSettings):ajaxData;data=$.isFunction(ajaxData)&&newData?newData:$.extend(!0,data,newData);delete ajax.data}
var baseAjax={data:data,dataType:"json",cache:!1,type:dtSettings.ajax.type||'GET',success:function(json){var error=json.error||json.sError;if(error)
_fnLog(dtSettings,0,error);dtSettings.json=json;callback(json)},error:function(xhr,error,thrown){if(_fnDtCallbackEnabled(dtSettings,'xhr'))
var ret=_fnCallbackFire(dtSettings,null,'xhr',[dtSettings,null,dtSettings.jqXHR]);if($.inArray(!0,ret)===-1){if(error=="parsererror"){_fnLog(dtSettings,0,'Invalid JSON response',1)}else if(xhr.readyState===4){_fnLog(dtSettings,0,'Ajax error',7)}}
_fnProcessingDisplay(dtSettings,!1)}};dtSettings.oAjaxData=data;if(_fnDtCallbackEnabled(dtSettings,'preXhr'))
_fnCallbackFire(dtSettings,null,'preXhr',[dtSettings,data]);xhrStart=new Date();if(dtSettings.fnServerData){dtSettings.fnServerData.call(instance,dtSettings.sAjaxSource,$.map(data,function(val,key){return{name:key,value:val}}),callback,dtSettings)}else if(dtSettings.sAjaxSource||typeof ajax==='string'){dtSettings.jqXHR=$.ajax($.extend(baseAjax,{url:ajax||dtSettings.sAjaxSource}))}else if($.isFunction(ajax)){dtSettings.jqXHR=ajax.call(instance,data,callback,dtSettings)}else{dtSettings.jqXHR=$.ajax($.extend(baseAjax,ajax));ajax.data=ajaxData}
dtSettings.jqXHR.done(function(json,textStatus,jqXHR){dtSettings.liveAjax.previousJson=json}).fail(function(jqXHR,textStatus,errorThrown){_fnCallbackFire(dtSettings,null,'xhrErr'+_ucfirst(textStatus||'unknown'),[dtSettings,dtSettings.jqXHR,errorThrown],'liveAjax');_fnCallbackFire(dtSettings,null,'xhrErr',[dtSettings,dtSettings.jqXHR,errorThrown],'liveAjax')}).always(function(data_jqXHR,textStatus,jqXHR_errorThrown){dtSettings.liveAjax.lastResult=textStatus;dtSettings.liveAjax.lastIteration=new Date();dtSettings.liveAjax.totalIterations++;dtSettings.liveAjax.lastDuration=new Date()-xhrStart})}
function _isXhrClear(dtSettings){return(dtSettings.jqXHR===undefined||$.inArray(dtSettings.jqXHR.readyState,[XHR_STATE_COMPLETE,XHR_STATE_NOT_INIT])!==-1)}
function _initUpdates(dtSettings){if(!_isXhrClear(dtSettings)){console.warn('liveAjax already initiated for table #'+dtSettings.nTable.id);return}(function _doTimeout(){dtSettings.liveAjax.updateLoop=setTimeout(function(){dtSettings.liveAjax.initReload(function(polledDtSettings){if($.inArray(polledDtSettings.liveAjax.lastResult,polledDtSettings.liveAjax.abortOn)===-1)
_doTimeout(polledDtSettings.liveAjax.interval);else _fnLog(polledDtSettings,0,'[liveAjax] Abortable status retrieved from last XHR request ('+polledDtSettings.liveAjax.lastResult+') - aborting updates',!1)})},dtSettings.liveAjax.interval)})();_fnCallbackFire(dtSettings,null,'init',[dtSettings,dtSettings.jqXHR],'liveAjax')}
function _clearTimeout(dtSettings){clearTimeout(dtSettings.liveAjax.updateLoop);_fnCallbackFire(dtSettings,null,'clearTimeout',[dtSettings,dtSettings.jqXHR],'liveAjax')}
function _abortXhr(dtSettings){try{dtSettings.jqXHR.abort()}
catch(err){dtSettings.liveAjax.latestError=err.message}
finally{_fnCallbackFire(dtSettings,null,'abortXhr',[dtSettings,dtSettings.jqXHR],'liveAjax')}}
function _setPauseStatus(dtSettings,status){dtSettings.liveAjax.paused=status;_fnCallbackFire(dtSettings,null,'setPause',[dtSettings,status],'liveAjax')}
var _defaults={interval:4000,resetPaging:!1,dtCallbacks:!1,abortOn:['error','timeout','parsererror'],onUpdate:function(updates,json,xhr){},noUpdate:function(json,xhr){}},_minInterval=1500;$(document).on('init.dt',function(e,dtSettings){if(e.namespace!=='dt')
return;var _options=dtSettings.oInit.liveAjax;if(_options!==!0&&!$.isPlainObject(_options))
return;if(dtSettings.oInit.ajax===undefined)
throw new Error('Can not initiate LiveAjax plugin on a non-ajax sourced table');var _api=new $.fn.dataTable.Api(dtSettings),_getOpt=function(item,isType){var defaultVal=_defaults[item]===undefined?null:_defaults[item];return($.isPlainObject(_options)&&_options[item]!==undefined&&(isType===undefined||typeof _options[item]===isType))?_options[item]:defaultVal},_processNewJson=function(json){if(dtSettings.liveAjax.previousJson===undefined){dtSettings.liveAjax.previousJson=json;return}
var doDraw=!1;try{if(json[dtSettings.liveAjax.dataSrc][0][dtSettings.liveAjax.rowId]===undefined){if(JSON.stringify(dtSettings.liveAjax.previousJson[dtSettings.liveAjax.dataSrc])!==JSON.stringify(json[dtSettings.liveAjax.dataSrc])){_api.clear().rows.add(json[dtSettings.liveAjax.dataSrc]);doDraw=!0}}else{var updates=_fnGetChanges(_fnKeyStructData(dtSettings.liveAjax.rowId,dtSettings.liveAjax.previousJson[dtSettings.liveAjax.dataSrc]),_fnKeyStructData(dtSettings.liveAjax.rowId,json[dtSettings.liveAjax.dataSrc]));if(updates!==null){if(updates.update!==undefined&&Object.keys(updates.update).length!==0)
$.each(updates.update,function(id,data){_api.row('#'+id).data(data)});if(updates.delete!==undefined&&updates.delete.length!==0)
_api.rows($.map(updates.delete,function(v,i){return'#'+v})).remove();if(updates.create!==undefined&&updates.create.length!==0)
_api.rows.add(updates.create);dtSettings.json=json;dtSettings.liveAjax.lastUpdates=updates;dtSettings.liveAjax.lastUpdate=new Date();dtSettings.liveAjax.totalUpdates++;doDraw=!0}}}catch(err){}
if(doDraw===!0){_api.draw(dtSettings.liveAjax.resetPaging);_fnCallbackFire(dtSettings,null,'onUpdate',[dtSettings,updates,json,dtSettings.jqXHR],'liveAjax');if(dtSettings.liveAjax.callbacks.onUpdate!==undefined)
dtSettings.liveAjax.callbacks.onUpdate(updates,json,dtSettings.jqXHR)}else{_fnCallbackFire(dtSettings,null,'noUpdate',[dtSettings,json,dtSettings.jqXHR],'liveAjax');if(dtSettings.liveAjax.callbacks.noUpdate!==undefined)
dtSettings.liveAjax.callbacks.noUpdate(json,dtSettings.jqXHR)}};dtSettings.liveAjax={interval:(_minInterval>parseInt(_getOpt('interval'))?_minInterval:parseInt(_getOpt('interval'))),initInterval:(_minInterval>parseInt(_getOpt('interval'))?_minInterval:parseInt(_getOpt('interval'))),dtCallbacks:_getOpt('dtCallbacks'),resetPaging:_getOpt('resetPaging'),abortOn:_getOpt('abortOn','array'),callbacks:{onUpdate:_getOpt('onUpdate','function'),noUpdate:_getOpt('noUpdate','function')},rowId:dtSettings.rowId,dataSrc:dtSettings.ajax.dataSrc||'data',previousJson:dtSettings.json,paused:!1,latestError:null,updateLoop:null,totalUpdates:0,totalIterations:0,lastCheck:null,lastUpdate:null,lastIteration:null,initReload:function(pollingFn,overridePause,doneCallback,failCallback,alwaysCallback){if(_isXhrClear(dtSettings)&&(dtSettings.liveAjax.paused===!1||overridePause===!0)){_fnBuildAjax(dtSettings,[],_processNewJson);dtSettings.jqXHR.done(function(data,textStatus,jqXHR){if(typeof doneCallback==='function')
doneCallback(data,textStatus,jqXHR)}).fail(function(jqXHR,textStatus,errorThrown){if(typeof failCallback==='function')
failCallback(jqXHR,textStatus,errorThrown)}).always(function(data_jqXHR,textStatus,jqXHR_errorThrown){if(typeof alwaysCallback==='function')
alwaysCallback(data_jqXHR,textStatus,jqXHR_errorThrown)})}else{_fnCallbackFire(dtSettings,null,'xhrSkipped',[dtSettings,(dtSettings.jqXHR.readyState<XHR_STATE_COMPLETE?'processing':'paused')],'liveAjax');if(typeof alwaysCallback==='function'){alwaysCallback(data_jqXHR,textStatus,jqXHR_errorThrown)}}
if(typeof pollingFn==='function'){pollingFn(dtSettings)}}};_initUpdates(dtSettings);var _destroyCallback=function(e,ctx){if($(_api.table().node()).attr('id')===ctx.nTable.id){_abortXhr(dtSettings);clearTimeout(dtSettings.liveAjax.updateLoop);_api.off('destroy.dt',_destroyCallback)}};_api.on('destroy.dt',_destroyCallback)});$.fn.dataTable.Api.register('liveAjax.initiate()',function(){return this.iterator('table',function(dtSettings){_initUpdates(dtSettings)})});$.fn.dataTable.Api.register('liveAjax.abortXhr()',function(){return this.iterator('table',function(dtSettings){_abortXhr(dtSettings)})});$.fn.dataTable.Api.register('liveAjax.clearTimeout()',function(abortXhr){return this.iterator('table',function(dtSettings){if(abortXhr===!0)
_abortXhr(dtSettings);_clearTimeout(dtSettings)})});$.fn.dataTable.Api.register('liveAjax.pause()',function(){return this.iterator('table',function(dtSettings){_setPauseStatus(dtSettings,!0)})});$.fn.dataTable.Api.register('liveAjax.resume()',function(){return this.iterator('table',function(dtSettings){_setPauseStatus(dtSettings,!1)})});$.fn.dataTable.Api.register('liveAjax.isPaused()',function(){return this.iterator('table',function(dtSettings){return dtSettings.liveAjax.paused},!1)[0]});$.fn.dataTable.Api.register('liveAjax.togglePause()',function(){return this.iterator('table',function(dtSettings){_setPauseStatus(dtSettings,!dtSettings.liveAjax.paused)})});$.fn.dataTable.Api.register('liveAjax.xhrStatus()',function(){return this.iterator('table',function(dtSettings){return dtSettings.jqXHR===undefined?undefined:dtSettings.jqXHR.readyState},!1)[0]});$.fn.dataTable.Api.register('liveAjax.reload()',function(overridePause,doneCallback,failCallback,alwaysCallback){return this.iterator('table',function(dtSettings){dtSettings.liveAjax.initReload(overridePause,doneCallback,failCallback,alwaysCallback)})});$.fn.dataTable.Api.register('liveAjax.setInterval()',function(int,immediate){return this.iterator('table',function(dtSettings){var newInt=int||dtSettings.liveAjax.initInterval;if(immediate===!0){_abortXhr(dtSettings);_clearTimeout(dtSettings);_initUpdates(dtSettings)}
dtSettings.liveAjax.interval=_minInterval>newInt?_minInterval:newInt;_fnCallbackFire(dtSettings,null,'setInterval',[dtSettings,dtSettings.liveAjax.interval],'liveAjax')})})})(window,document,jQuery)